{% extends "admin/base.html" %}

{% block title %}{% if edit_mode %}ç·¨è¼¯è§’è‰²{% else %}æ–°å¢è§’è‰²{% endif %}{% endblock %}

{% block extra_style %}
<style>
h2 {
    color: #333;
    text-align: center;
    margin-bottom: 30px;
}
.form-group {
    margin-bottom: 20px;
}
label {
    display: block;
    margin-bottom: 5px;
    font-weight: bold;
    color: #333;
}
input, textarea {
    width: 100%;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 6px;
    font-size: 14px;
    box-sizing: border-box;
}
textarea {
    height: 80px;
    resize: vertical;
}
.section {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 8px;
    margin: 20px 0;
}
.section-title {
    font-size: 1.2em;
    color: #333;
    margin-bottom: 15px;
    border-bottom: 2px solid #007bff;
    padding-bottom: 5px;
}
.dynamic-fields {
    display: grid;
    gap: 15px;
}
.field-row {
    display: grid;
    grid-template-columns: 1fr 100px auto;
    gap: 10px;
    align-items: end;
}
.field-row.item-row {
    grid-template-columns: 2fr 100px 2fr auto;
}
.actions {
    text-align: center;
    margin-top: 30px;
    display: flex;
    gap: 15px;
    justify-content: center;
}
.remove-btn {
    padding: 5px 10px;
    font-size: 12px;
}
</style>
{% endblock %}

{% block extra_head %}
<script>
    function addStatField() {
        const container = document.getElementById('stats-container');
        const div = document.createElement('div');
        div.className = 'field-row';
        div.innerHTML = `
            <input name="stat_name" placeholder="æ•¸å€¼åç¨±" value="">
            <input name="stat_value" type="number" placeholder="æ•¸å€¼" value="">
            <button type="button" class="btn btn-danger remove-btn" onclick="removeField(this)">ç§»é™¤</button>
        `;
        container.appendChild(div);
    }

    function addItemField() {
        const container = document.getElementById('items-container');
        const div = document.createElement('div');
        div.className = 'field-row item-row';
        div.innerHTML = `
            <div style="display: flex; gap: 5px;">
                <input name="item_name" placeholder="é“å…·åç¨±" value="" style="flex: 1;">
                <select onchange="fillItemFromTemplate(this)" style="width: 80px;">
                    <option value="">å¾æ¨¡æ¿</option>
                    {% for template in templates %}
                    <option value="{{ template.name }}" data-desc="{{ template.description }}">{{ template.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <input name="item_count" type="number" placeholder="æ•¸é‡" value="">
            <input name="item_desc" placeholder="é“å…·æè¿°" value="">
            <button type="button" class="btn btn-danger remove-btn" onclick="removeField(this)">ç§»é™¤</button>
        `;
        container.appendChild(div);
    }
    
    function fillItemFromTemplate(select) {
        if (select.value) {
            const row = select.closest('.field-row');
            const nameInput = row.querySelector('input[name="item_name"]');
            const descInput = row.querySelector('input[name="item_desc"]');
            const selectedOption = select.options[select.selectedIndex];
            
            nameInput.value = select.value;
            descInput.value = selectedOption.dataset.desc || '';
            
            // é‡ç½®é¸æ“‡å™¨
            select.value = '';
        }
    }

    function removeField(btn) {
        btn.parentElement.remove();
    }
</script>
{% endblock %}

{% block content %}
<div class="container">
    <h2>{% if edit_mode %}âœï¸ ç·¨è¼¯è§’è‰²{% else %}â• æ–°å¢è§’è‰²{% endif %}</h2>
    
    <form method="POST" enctype="multipart/form-data">
        <div class="form-group">
            <label>è§’è‰²åç¨±</label>
            <input name="name" placeholder="è¼¸å…¥è§’è‰²åç¨±" value="{{ player.name if player else '' }}" required>
        </div>
        
        <div class="form-group">
            <label>è§’è‰²ç°¡ä»‹</label>
            <textarea name="bio" placeholder="è¼¸å…¥è§’è‰²ç°¡ä»‹...">{{ player.bio if player else '' }}</textarea>
        </div>
        
        <div class="form-group">
            <label>ç™»å…¥å¯†ç¢¼</label>
            <input name="password" type="password" placeholder="è¨­å®šè§’è‰²ç™»å…¥å¯†ç¢¼" {% if not edit_mode %}required{% endif %}>
            {% if edit_mode %}<small style="color: #666;">ç•™ç©ºè¡¨ç¤ºä¸æ›´æ”¹å¯†ç¢¼</small>{% endif %}
        </div>
        
        <div class="form-group">
            <label>é ­åƒåœ–ç‰‡</label>
            <input type="file" name="avatar" accept="image/*">
            {% if edit_mode and player.avatar_url %}<small style="color: #666;">ç›®å‰é ­åƒï¼š{{ player.avatar_url }}</small>{% endif %}
        </div>

        <div class="section">
            <div class="section-title">ğŸ“Š è§’è‰²æ•¸å€¼</div>
            <div id="stats-container" class="dynamic-fields">
                {% if edit_mode and player.stats %}
                    {% for stat in player.stats %}
                    <div class="field-row">
                        <input name="stat_name" placeholder="æ•¸å€¼åç¨±" value="{{ stat.name }}">
                        <input name="stat_value" type="number" placeholder="æ•¸å€¼" value="{{ stat.value }}">
                        <button type="button" class="btn btn-danger remove-btn" onclick="removeField(this)">ç§»é™¤</button>
                    </div>
                    {% endfor %}
                {% else %}
                    {% for i in range(3) %}
                    <div class="field-row">
                        <input name="stat_name" placeholder="æ•¸å€¼åç¨±" value="">
                        <input name="stat_value" type="number" placeholder="æ•¸å€¼" value="">
                        <button type="button" class="btn btn-danger remove-btn" onclick="removeField(this)">ç§»é™¤</button>
                    </div>
                    {% endfor %}
                {% endif %}
            </div>
            <button type="button" class="btn btn-success" onclick="addStatField()" style="margin-top: 10px;">+ æ–°å¢æ•¸å€¼</button>
        </div>

        <div class="section">
            <div class="section-title">ğŸ’ è§’è‰²é“å…·</div>
            <div id="items-container" class="dynamic-fields">
                {% if edit_mode and player.items %}
                    {% for item in player.items %}
                    <div class="field-row item-row">
                        <div style="display: flex; gap: 5px;">
                            <input name="item_name" placeholder="é“å…·åç¨±" value="{{ item.name }}" style="flex: 1;">
                            <select onchange="fillItemFromTemplate(this)" style="width: 80px;">
                                <option value="">å¾æ¨¡æ¿</option>
                                {% for template in templates %}
                                <option value="{{ template.name }}" data-desc="{{ template.description }}">{{ template.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <input name="item_count" type="number" placeholder="æ•¸é‡" value="{{ item.count }}">
                        <input name="item_desc" placeholder="é“å…·æè¿°" value="{{ item.description }}">
                        <button type="button" class="btn btn-danger remove-btn" onclick="removeField(this)">ç§»é™¤</button>
                    </div>
                    {% endfor %}
                {% else %}
                    {% for i in range(3) %}
                    <div class="field-row item-row">
                        <div style="display: flex; gap: 5px;">
                            <input name="item_name" placeholder="é“å…·åç¨±" value="" style="flex: 1;">
                            <select onchange="fillItemFromTemplate(this)" style="width: 80px;">
                                <option value="">å¾æ¨¡æ¿</option>
                                {% for template in templates %}
                                <option value="{{ template.name }}" data-desc="{{ template.description }}">{{ template.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <input name="item_count" type="number" placeholder="æ•¸é‡" value="">
                        <input name="item_desc" placeholder="é“å…·æè¿°" value="">
                        <button type="button" class="btn btn-danger remove-btn" onclick="removeField(this)">ç§»é™¤</button>
                    </div>
                    {% endfor %}
                {% endif %}
            </div>
            <button type="button" class="btn btn-success" onclick="addItemField()" style="margin-top: 10px;">+ æ–°å¢é“å…·</button>
        </div>

        <div class="actions">
            <button type="submit" class="btn btn-primary">
                {% if edit_mode %}ğŸ’¾ å„²å­˜ä¿®æ”¹{% else %}âœ… å»ºç«‹è§’è‰²{% endif %}
            </button>
            <a href="{{ url_for('admin.dashboard') }}" class="btn btn-secondary">å–æ¶ˆ</a>
        </div>
    </form>
</div>
{% endblock %}
